<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>스마트팜 대시보드</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #3b82f6;
      --secondary-color: #f3f4f6;
      --text-color: #1f2937;
      --muted-color: #6b7280;
      --border-color: #e5e7eb;
      --card-bg: #ffffff;
      --bg-color: #f9fafb;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      
      /* 센서 색상 */
      --temp-color: #f97316;
      --humidity-color: #3b82f6;
      --soil-color: #FFDF00;
      --co2-color: #10b981;
      
      /* 장치 색상 */
      --led-color: #facc15;
      --fan-color: #3b82f6;
      --water-color: #06b6d4;
      --heater-color: #ef4444;
      --cooler-color: #6366f1;
      
      --border-radius: 0.5rem;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .header-right {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      align-items: center;
    }

    .logout-btn {
      position: flex;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      text-decoration: underline;
    }
    

    .date-picker {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      cursor: pointer;
    }

    main {
      flex: 1;
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      border-bottom: 2px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 500;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .grid {
      display: grid;
      gap: 1.5rem;
    }

    .grid-cols-1 {
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .grid-cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .grid-cols-5 {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-description {
      color: var(--muted-color);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .card-content {
      padding: 1.5rem;
    }

    .card-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
    }

    .sensor-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .sensor-unit {
      font-size: 1rem;
      font-weight: normal;
      color: var(--muted-color);
      margin-left: 0.25rem;
    }

    .progress-container {
      width: 100%;
      height: 0.5rem;
      background-color: var(--secondary-color);
      border-radius: 9999px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      border-radius: 9999px;
    }

    .progress-bar.temp {
      background-color: var(--temp-color);
    }

    .progress-bar.humidity {
      background-color: var(--humidity-color);
    }

    .progress-bar.soil {
      background-color: var(--soil-color);
    }

    .progress-bar.co2 {
      background-color: var(--co2-color);
    }

    .device-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .device-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .device-icon {
      width: 4rem;
      height: 4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      background-color: var(--secondary-color);
      font-size: 1.5rem;
      color: var(--muted-color);
    }

    .device-icon.active.led {
      background-color: rgba(250, 204, 21, 0.2);
      color: var(--led-color);
    }

    .device-icon.active.fan {
      background-color: rgba(59, 130, 246, 0.2);
      color: var(--fan-color);
    }

    .device-icon.active.water {
      background-color: rgba(6, 182, 212, 0.2);
      color: var(--water-color);
    }

    .device-icon.active.heater {
      background-color: rgba(239, 68, 68, 0.2);
      color: var(--heater-color);
    }

    .device-icon.active.cooler {
      background-color: rgba(99, 102, 241, 0.2);
      color: var(--cooler-color);
    }

    .device-name {
      font-weight: 500;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 3rem;
      height: 1.5rem;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--secondary-color);
      transition: .4s;
      border-radius: 9999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 1rem;
      width: 1rem;
      left: 0.25rem;
      bottom: 0.25rem;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary-color);
    }

    input:checked + .slider:before {
      transform: translateX(1.5rem);
    }

    .switch-label {
      margin-left: 0.5rem;
    }

    .chart-container {
      width: 100%;
      height: 300px;
      position: relative;
    }

    .sensor-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .sensor-tab {
      padding: 0.75rem;
      text-align: center;
      border-radius: var(--border-radius);
      cursor: pointer;
      background-color: var(--secondary-color);
    }

    .sensor-tab.active.temp {
      background-color: rgba(249, 115, 22, 0.2);
      color: var(--temp-color);
    }

    .sensor-tab.active.humidity {
      background-color: rgba(59, 130, 246, 0.2);
      color: var(--humidity-color);
    }

    .sensor-tab.active.soil {
      background-color: rgba(217, 119, 6, 0.2);
      color: var(--soil-color);
    }

    .sensor-tab.active.co2 {
      background-color: rgba(16, 185, 129, 0.2);
      color: var(--co2-color);
    }

    .sensor-chart {
      display: none;
      height: 400px;
    }

    .sensor-chart.active {
      display: block;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background-color: var(--secondary-color);
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .spin {
      animation: spin 2s linear infinite;
    }

    .switch-container {
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <h1 class="header-title">스마트팜 대시보드</h1>
      <div class="header-right">
        <span id="farmname" style="color: #1a7e56; font-size: 20px; font-weight: bold;">New 스마트팜</span>
        <span id="username">홍길동님</span>
        <button class="logout-btn" id="logout-btn">로그아웃</button>
        <!--<div class="date-picker" id="datePicker">
          <i class="fas fa-calendar"></i>
          <span id="currentDate"></span>
        </div>-->
      </div>
    </div>
  </header>

  <main>
    <div class="tabs">
      <div class="tab active" data-tab="current">현재 상태</div>
      <div class="tab" data-tab="history">기록 데이터</div>
    </div>

    <!-- 현재 상태 탭 -->
    <div class="tab-content active" id="current-tab">
      <!-- 센서 데이터 카드 -->
      <div class="grid grid-cols-1 grid-cols-2 grid-cols-4">
        <!-- 온도 카드 -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-temperature-high" style="color: var(--temp-color);"></i>
              온도
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value temp">
              0<span class="sensor-unit">°C</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar temp" style="width: 63%;"></div>
            </div>
          </div>
        </div>

        <!-- 습도 카드 -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-tint" style="color: var(--humidity-color);"></i>
              습도
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value humidity">
              0<span class="sensor-unit">%</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar humidity" style="width: 62%;"></div>
            </div>
          </div>
        </div>

        <!-- 토양 수분 카드 -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-leaf" style="color: var(--soil-color);"></i>
              토양 수분
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value soil">
              0<span class="sensor-unit">%</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar soil" style="width: 55%;"></div>
            </div>
          </div>
        </div>

        <!-- CO2 카드 -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-wind" style="color: var(--co2-color);"></i>
              CO2
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value co2">
              0<span class="sensor-unit">ppm</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar co2" style="width: 42%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 장치 제어 카드 -->
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">장치 제어</div>
          <div class="card-description">스마트팜 장치를 원격으로 제어합니다</div>
        </div>
        <div class="card-content">
          <div class="device-grid">
            <!-- LED 제어 -->
            <div class="device-item">
              <div class="device-icon led" id="led-icon">
                <i class="fas fa-lightbulb"></i>
              </div>
              <div class="device-name">LED</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="led-switch" onchange="updateDevice('led')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="led-status">꺼짐</span>
              </div>
            </div>

            <!-- 환풍팬 제어 -->
            <div class="device-item">
              <div class="device-icon fan" id="fan-icon">
                <i class="fas fa-fan"></i>
              </div>
              <div class="device-name">환풍팬</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="fan-switch" onchange="updateDevice('fan')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="fan-status">꺼짐</span>
              </div>
            </div>

            <!-- 물주기 제어 -->
            <div class="device-item">
              <div class="device-icon water" id="water-icon">
                <i class="fas fa-tint"></i>
              </div>
              <div class="device-name">물주기</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="water-switch" onchange="updateDevice('water')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="water-status">꺼짐</span>
              </div>
            </div>

            <!-- 히터 제어 -->
            <div class="device-item">
              <div class="device-icon heater" id="heater-icon">
                <i class="fas fa-fire"></i>
              </div>
              <div class="device-name">히터</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="heater-switch" onchange="updateDevice('heater')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="heater-status">꺼짐</span>
              </div>
            </div>

            <!-- 쿨러 제어 -->
            <div class="device-item">
              <div class="device-icon cooler" id="cooler-icon">
                <i class="fas fa-wind"></i>
              </div>
              <div class="device-name">쿨러</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="cooler-switch" onchange="updateDevice('cooler')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="cooler-status">꺼짐</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 실시간 센서 데이터 그래프 -->
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">실시간 센서 데이터</div>
          <div class="card-description">최근 24시간 데이터 추이</div>
        </div>
        <div class="card-content">
          <div class="chart-container">
            <canvas id="realtime-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- 기록 데이터 탭 -->
    <div class="tab-content" id="history-tab">
      <div class="card">
        <div class="card-header">
          <div class="card-title">센서 데이터 기록</div>
          <div class="card-description" id="history-date"></div>
        </div>
        <div class="card-content">
          <div class="sensor-tabs">
            <div class="sensor-tab active temp" data-sensor="temperature">온도</div>
            <div class="sensor-tab humidity" data-sensor="humidity">습도</div>
            <div class="sensor-tab soil" data-sensor="soil">토양 수분</div>
            <div class="sensor-tab co2" data-sensor="co2">CO2</div>
          </div>

          <div class="sensor-chart active" id="temperature-chart">
            <canvas id="temperature-canvas"></canvas>
          </div>
          <div class="sensor-chart" id="humidity-chart">
            <canvas id="humidity-canvas"></canvas>
          </div>
          <div class="sensor-chart" id="soil-chart">
            <canvas id="soil-canvas"></canvas>
          </div>
          <div class="sensor-chart" id="co2-chart">
            <canvas id="co2-canvas"></canvas>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn" id="prev-date">
            <i class="fas fa-chevron-left"></i>
            이전 날짜
          </button>
          <button class="btn" id="next-date">
            다음 날짜
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- 일일 센서 데이터 요약 -->
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">일일 센서 데이터 요약</div>
          <div class="card-description" id="summary-date"></div>
        </div>
        <div class="card-content">
          <div class="chart-container">
            <canvas id="summary-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
     // 로그아웃 처리 
     const logoutButton = document.getElementById("logout-btn");       
     logoutButton.addEventListener("click", () => {
      sessionStorage.removeItem("user_id");
      alert("로그아웃");
      window.location.href = "login.html";
    });
    document.addEventListener('DOMContentLoaded', async () => {
      // 현재 날짜 설정
      const today = new Date();
      let currentDate = new Date();

      // 날짜 포맷 함수
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const weekdays = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        const weekday = weekdays[date.getDay()];

        // 날짜 포맷: "2025년 02월 27일 (금요일)"
        return `${year}년 ${month}월 ${day}일 (${weekday})`;
      }

      // 날짜 표시 업데이트
      function updateDateDisplay() {
        // 날짜 표시 업데이트
        const formattedDate = formatDate(currentDate);
        
        // 'currentDate'와 'history-date'에 날짜만 표시
        //document.getElementById('currentDate').textContent = formattedDate.split(' (')[0];
        document.getElementById('history-date').textContent = formattedDate;
        document.getElementById('summary-date').textContent = `${currentDate.getFullYear()}년 ${currentDate.getMonth() + 1}월 ${currentDate.getDate()}일 센서별 평균값`;
      }

      // 탭 전환 기능
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          // 탭 활성화
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // 탭 컨텐츠 활성화
          tabContents.forEach(content => content.classList.remove('active'));
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });
      
      // 센서 탭 전환 기능
      const sensorTabs = document.querySelectorAll('.sensor-tab');
      const sensorCharts = document.querySelectorAll('.sensor-chart');
      
      sensorTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const sensorId = tab.getAttribute('data-sensor');
          
          // 센서 탭 활성화
          sensorTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // 센서 차트 활성화
          sensorCharts.forEach(chart => chart.classList.remove('active'));
          document.getElementById(`${sensorId}-chart`).classList.add('active');
        });
      });
      
      document.getElementById('prev-date').addEventListener('click', async () => {
        currentDate.setDate(currentDate.getDate() - 1);
        updateDateDisplay();
        await updateAllCharts(); // 데이터를 기다리고 차트 업데이트
      });
      
      document.getElementById('next-date').addEventListener('click', async () => {
        if (currentDate < today) {
          currentDate.setDate(currentDate.getDate() + 1);
          updateDateDisplay();
          await updateAllCharts(); // 데이터를 기다리고 차트 업데이트
        }
      });

      // 세션스토리지에서 user_id와 farm_id 가져오기
      const userId = sessionStorage.getItem('user_id');
      const farmId = sessionStorage.getItem('farm_id');

      // 농장 이름 불러오기
      function fetchFarmName() {
        fetch(`/getFarmName?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const farmname = data.farmname;
                    document.getElementById('farmname').textContent = `${farmname}`;
                } else {
                    console.error('스마트팜 이름을 불러오지 못했습니다:', data.message);
                }
            })
            .catch(error => console.error("스마트팜 이름 불러오기 실패:", error));
      } 

      // 이름 불러오기
      function fetchName() {
        fetch(`/getName?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const username = data.username;
                    document.getElementById('username').textContent = `${username}님`;
                } else {
                    console.error('사용자 이름을 불러오지 못했습니다:', data.message);
                }
            })
            .catch(error => console.error("사용자 이름 불러오기 실패:", error));
      }  

      // 센서 데이터를 가져와 화면에 업데이트하는 함수
      async function fetchSensorData() {
        try {
          if (!userId) {
            alert("사용자 정보를 확인할 수 없습니다. 로그인 후 다시 시도해주세요.");
            window.location.href = "login.html";
            return;
          }

          if (!farmId) {
            alert("스마트팜 정보를 확인할 수 없습니다. 스마트팜 추가가 후 다시 시도해주세요.");
            window.location.href = "farm.html";
            return;
          }

          // user_id와 farm_id가 존재할 경우에만 요청
          if (userId && farmId) {
            const response = await fetch(`/sensors/status?user_id=${userId}&farm_id=${farmId}`);
                
            if (!response.ok) {
              throw new Error('네트워크 응답 오류');
            }

            // JSON 데이터 파싱
            const data = await response.json();
            console.log('최신 센서 데이터:', data);

            // 각 센서 데이터 업데이트
            updateSensorUI('temperature', data.temperature, 'temp', 0, 40); // 온도
            updateSensorUI('humidity', data.humidity, 'humidity', 0, 100); // 습도
            updateSensorUI('soil_moisture', data.soil_moisture, 'soil', 0, 100); // 토양 수분
            updateSensorUI('co2', data.co2, 'co2', 0, 1000); // CO2

          } else {
            console.error('user_id 또는 farm_id가 존재하지 않습니다.');
          }
        } catch (error) {
            console.error('데이터 가져오기 실패:', error);
        }
      }

      // 센서 UI 업데이트 함수
      function updateSensorUI(sensorType, value, className, min, max) {
        // 센서 값과 단위 설정
        let unit = '';
        switch (sensorType) {
            case 'temperature':
                unit = '°C';
                break;
            case 'humidity':
            case 'soil_moisture':
                unit = '%';
                break;
            case 'co2':
                unit = 'ppm';
                break;
        }

        // 센서 값 업데이트
        const valueElement = document.querySelector(`.sensor-value.${className}`);
        if (valueElement) {
            valueElement.innerHTML = `${value}<span class="sensor-unit">${unit}</span>`;
        }

        // 진행 바 너비 계산 및 업데이트
        const progressBar = document.querySelector(`.progress-container .progress-bar.${className}`);
        if (progressBar) {
            const percentage = ((value - min) / (max - min)) * 100;
            progressBar.style.width = `${Math.min(Math.max(percentage, 0), 100)}%`;
        }
      }
      // 상태 가져오기
      async function fetchDevicesStatus() {
        try {
          if (userId && farmId) {
            const response = await fetch(`/devices/status?user_id=${userId}&farm_id=${farmId}`);
      
            if (!response.ok) {
              throw new Error('네트워크 응답 오류: ' + response.statusText);
            }
      
            // 응답 데이터 확인
            const data = await response.json();
            console.log('제어장치 상태:', data);
      
            // 각 장치의 상태 업데이트
            updateSwitchUI('led', data.led);
            updateSwitchUI('fan', data.fan);
            updateSwitchUI('water', data.water);
            updateSwitchUI('heater', data.heater);
            updateSwitchUI('cooler', data.cooler);
          } else {
            console.error('user_id 또는 farm_id가 존재하지 않습니다.');
          }
        } catch (error) {
          console.error('상태 가져오기 실패:', error);
        }
      }

      // 실시간 데이터 불러오기기
      async function fetchRealtimeData() {
        try {
          const response = await fetch(`/realtime-data?user_id=${userId}&farm_id=${farmId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();
      
          // 서버 응답 데이터 형식에 따라 가공
          const processedData = data.map(item => ({
            time: new Date(item.time_interval).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false }),
            temperature: parseFloat(item.avg_temperature),
            humidity: parseFloat(item.avg_humidity),
            soil: parseFloat(item.avg_soil_moisture),
            co2: parseInt(item.avg_co2)
          }));
      
          return processedData;
        } catch (error) {
          console.error('데이터 가져오기 오류:', error);
          return [];
        }
      }    

      // 실시간 차트 데이터 업데이트
      async function updateChartData() {
        const realtimeData = await fetchRealtimeData();
        
        // 차트 데이터 갱신
        realtimeChart.data.labels = realtimeData.map(item => item.time);
        realtimeChart.data.datasets[0].data = realtimeData.map(item => item.temperature);
        realtimeChart.data.datasets[1].data = realtimeData.map(item => item.humidity);
        realtimeChart.data.datasets[2].data = realtimeData.map(item => item.soil);
        realtimeChart.data.datasets[3].data = realtimeData.map(item => item.co2);
        
        realtimeChart.update();
      }

      // 차트 초기화
      const realtimeChart = new Chart(
        document.getElementById('realtime-chart'),
        {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: '온도 (°C)',
                data: [],
                borderColor: 'rgb(249, 115, 22)',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y1', 
              },
              {
                label: '습도 (%)',
                data: [],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y1',  
              },
              {
                label: '토양 수분 (%)',
                data: [],
                borderColor: 'rgb(255, 223, 0)',
                backgroundColor: 'rgba(255, 223, 0, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y1', 
              },
              {
                label: 'CO2 (ppm)',
                data: [],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y2',  
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              // 좌측 y축 (온도, 습도, 토양 수분)
              y1: {
                beginAtZero: false,
                position: 'left',
                ticks: {
                  max: 80, 
                  min: 0, 
                }
              },
              // 우측 y축 (CO2)
              y2: {
                beginAtZero: false,
                position: 'right',
                grid: {
                  drawOnChartArea: false, 
                },
                ticks: {
                  max: 1000, 
                  min: 0,  
                }
              }
            }
          }
        }
      );
      
      // 기록 데이터 가져오기
      async function fetchHistoryData() {
        // "2025년 02월 27일 (목요일)"에서 "2025년 02월 27일"만 추출
        const selectedDate = document.getElementById('history-date').innerText.split(' (')[0];
      
        // 날짜 변환: "2025년 02월 27일" -> "2025-02-27"
        let formattedDate = selectedDate.replace('년', '-').replace('월', '-').replace('일', '').replace(/\s+/g, '').trim();
      
        // '2025-02-27' 형식인지 확인하고, 아니면 오류 처리
        const datePattern = /^\d{4}-\d{2}-\d{2}$/;
        if (!datePattern.test(formattedDate)) {
          console.error('날짜 형식이 잘못되었습니다:', formattedDate);
          return { timeLabels: [], temperatureData: [], humidityData: [], soilData: [], co2Data: [] };
        }
      
        try {
          // 서버 API 호출
          const response = await fetch(`/history-data?user_id=${userId}&farm_id=${farmId}&date=${formattedDate}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });
      
          const data = await response.json();
      
          // 서버 응답이 배열인지 확인
          if (!Array.isArray(data)) {
            console.error('서버 응답 데이터가 배열이 아닙니다.', data);
            return { timeLabels: [], temperatureData: [], humidityData: [], soilData: [], co2Data: [] };
          }
      
          // 서버 응답 데이터 가공
          const processedData = {
            timeLabels: data.map(item => new Date(item.time_interval).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false })),
            temperatureData: data.map(item => parseFloat(item.avg_temperature)),
            humidityData: data.map(item => parseFloat(item.avg_humidity)),
            soilData: data.map(item => parseFloat(item.avg_soil_moisture)),
            co2Data: data.map(item => parseInt(item.avg_co2)),
          };
      
          return processedData;
        } catch (error) {
          console.error('기록 데이터 가져오기 오류:', error);
          return { timeLabels: [], temperatureData: [], humidityData: [], soilData: [], co2Data: [] };
        }
      }

      // 변수 선언을 추가합니다.
      let timeLabels = [];
      let temperatureData = [];
      let humidityData = [];
      let soilData = [];
      let co2Data = [];

      // 기록 차트 데이터 갱신
      async function updateHistoryChartData() {
        const historyData = await fetchHistoryData();
      
        // 온도 차트 업데이트
        temperatureChart.data.labels = historyData.timeLabels;
        temperatureChart.data.datasets[0].data = historyData.temperatureData;
        temperatureChart.update();
      
        // 습도 차트 업데이트
        humidityChart.data.labels = historyData.timeLabels;
        humidityChart.data.datasets[0].data = historyData.humidityData;
        humidityChart.update();
      
        // 토양 수분 차트 업데이트
        soilChart.data.labels = historyData.timeLabels;
        soilChart.data.datasets[0].data = historyData.soilData;
        soilChart.update();
      
        // CO2 차트 업데이트
        co2Chart.data.labels = historyData.timeLabels;
        co2Chart.data.datasets[0].data = historyData.co2Data;
        co2Chart.update();
      }    

      // 온도 차트
      const temperatureChart = new Chart(
        document.getElementById('temperature-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: '온도 (°C)',
                data: temperatureData,
                borderColor: 'rgb(249, 115, 22)',
                backgroundColor: 'rgba(249, 115, 22, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 40,
                title: {
                  display: true,
                  text: '온도 (°C)'
                }
              }
            }
          }
        }
      );
      
      // 습도 차트
      const humidityChart = new Chart(
        document.getElementById('humidity-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: '습도 (%)',
                data: humidityData,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 100,
                title: {
                  display: true,
                  text: '습도 (%)'
                }
              }
            }
          }
        }
      );
      
      // 토양 수분 차트
      const soilChart = new Chart(
        document.getElementById('soil-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: '토양 수분 (%)',
                data: soilData,
                borderColor: 'rgb(217, 119, 6)',
                backgroundColor: 'rgba(217, 119, 6, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 100,
                title: {
                  display: true,
                  text: '토양 수분 (%)'
                }
              }
            }
          }
        }
      );
      
      // CO2 차트
      const co2Chart = new Chart(
        document.getElementById('co2-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: 'CO2 (ppm)',
                data: co2Data,
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 1000,
                title: {
                  display: true,
                  text: 'CO2 (ppm)'
                }
              }
            }
          }
        }
      );

      // 평균 데이터
      async function updateSummaryChart() {
        const historyData = await fetchHistoryData();
        
        // 각 항목의 평균값 계산
        const avgTemperature = roundToTwo(average(historyData.temperatureData));
        const avgHumidity = roundToTwo(average(historyData.humidityData));
        const avgSoil = roundToTwo(average(historyData.soilData));
        const avgCo2 = roundToTwo(average(historyData.co2Data)); // CO2는 10으로 나누지 않음, 후에 차트에서 나누기
        
        // 요약 차트 데이터 업데이트
        summaryChart.data.datasets[0].data = [avgTemperature]; // 온도 평균값
        summaryChart.data.datasets[1].data = [avgHumidity];   // 습도 평균값
        summaryChart.data.datasets[2].data = [avgSoil];       // 토양 수분 평균값
        summaryChart.data.datasets[3].data = [avgCo2 / 10];   // CO2 평균값 (차트에서만 나누기)
        
        summaryChart.update();
      }
      
      // 평균값 계산 함수
      function average(dataArray) {
        if (dataArray.length === 0) return 0;
        const sum = dataArray.reduce((acc, value) => acc + value, 0);
        return sum / dataArray.length;
      }
      
      // 소수점 2자리 반올림 함수
      function roundToTwo(num) {
        return Math.round(num * 100) / 100;
      }

      // 요약 차트
      const summaryChart = new Chart(
        document.getElementById('summary-chart'),
        {
          type: 'bar',
          data: {
            labels: ['평균값'],
            datasets: [
              {
                label: '온도 (°C)',
                data: [24.5],
                backgroundColor: 'rgba(249, 115, 22, 0.7)',
                borderColor: 'rgb(249, 115, 22)',
                borderWidth: 1
              },
              {
                label: '습도 (%)',
                data: [65],
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
              },
              {
                label: '토양 수분 (%)',
                data: [42],
                backgroundColor: 'rgba(217, 119, 6, 0.7)',
                borderColor: 'rgb(217, 119, 6)',
                borderWidth: 1
              },
              {
                label: 'CO2 (ppm/10)',
                data: [65],
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: 'rgb(16, 185, 129)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.dataset.label === 'CO2 (ppm/10)') {
                      label += context.raw * 10; // 툴팁에서 원본 CO2 값으로 복원
                    } else {
                      label += context.raw;
                    }
                    return label;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        }
      );   

      // 기록, 요약약 차트 업데이트 함수
      async function updateAllCharts() {
        const historyData = await fetchHistoryData();

        // historyData가 필요한 데이터를 모두 가지고 있는지 확인
        if (!historyData.timeLabels || !historyData.temperatureData || !historyData.humidityData || !historyData.soilData || !historyData.co2Data) {
          console.error('History data가 부족합니다');
          return;
        }

        // 새로운 데이터 할당
        const newTimeLabels = historyData.timeLabels;
        const newTemperatureData = historyData.temperatureData;
        const newHumidityData = historyData.humidityData;
        const newSoilData = historyData.soilData;
        const newCo2Data = historyData.co2Data;

        // realtimeChart 업데이트
        //realtimeChart.data.labels = newTimeLabels;
        //realtimeChart.data.datasets[0].data = newTemperatureData;
        //realtimeChart.data.datasets[1].data = newHumidityData;
        //realtimeChart.data.datasets[2].data = newSoilData;
        //realtimeChart.data.datasets[3].data = newCo2Data;
        //realtimeChart.update();

        // temperatureChart 업데이트
        temperatureChart.data.labels = newTimeLabels;
        temperatureChart.data.datasets[0].data = newTemperatureData;
        temperatureChart.update();

        // humidityChart 업데이트
        humidityChart.data.labels = newTimeLabels;
        humidityChart.data.datasets[0].data = newHumidityData;
        humidityChart.update();

        // soilChart 업데이트
        soilChart.data.labels = newTimeLabels;
        soilChart.data.datasets[0].data = newSoilData;
        soilChart.update();

        // co2Chart 업데이트
        co2Chart.data.labels = newTimeLabels;
        co2Chart.data.datasets[0].data = newCo2Data;
        co2Chart.update();

        // summaryChart 평균값으로 업데이트
        const tempAvg = newTemperatureData.reduce((a, b) => a + b, 0) / newTemperatureData.length;
        const humidityAvg = newHumidityData.reduce((a, b) => a + b, 0) / newHumidityData.length;
        const soilAvg = newSoilData.reduce((a, b) => a + b, 0) / newSoilData.length;
        const co2Avg = newCo2Data.reduce((a, b) => a + b, 0) / newCo2Data.length / 10;

        summaryChart.data.datasets[0].data = [tempAvg.toFixed(1)];
        summaryChart.data.datasets[1].data = [humidityAvg.toFixed(1)];
        summaryChart.data.datasets[2].data = [soilAvg.toFixed(1)];
        summaryChart.data.datasets[3].data = [co2Avg.toFixed(1)];
        summaryChart.update();
      }

      fetchFarmName() // 스마트팜 이름 가져오기
      fetchName(); // 사용자 이름 가져오기
      updateDateDisplay(); // 날짜 표시 업데이트
      fetchSensorData(); // 센서 데이터 가져오기
      fetchDevicesStatus(); // 장치 상태 가져오기
      updateChartData(); // 실시간 차트 가져오기
      updateHistoryChartData(); // 기록 차트 가져오기
      updateSummaryChart(); // 요약 차트 가져오기

      //setInterval(fetchSensorData, 5000);
      //setInterval(updateChartData, 300000);
    });

    // 세션스토리지에서 user_id와 farm_id 가져오기
    const userId = sessionStorage.getItem('user_id');
    const farmId = sessionStorage.getItem('farm_id');

    // 상태 변경하기
    async function updateDevice(device) {
      try {
        // user_id와 farm_id가 존재할 경우에만 요청
        if (userId && farmId) {
          // 현재 토글 상태 확인
          const isChecked = document.getElementById(`${device}-switch`).checked;

          // 서버로 상태 변경 요청
          await fetch(`/devices/${device}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              user_id: userId, 
              farm_id: farmId, 
              device: device, 
              status: isChecked 
            })
          });

          // 상태 업데이트
          updateSwitchUI(device, isChecked);

        } else {
            console.error('user_id 또는 farm_id가 존재하지 않습니다.');
        }
      } catch (error) {
          console.error('상태 변경 실패:', error);
      }
    }

    // 스위치 UI 업데이트 함수
    function updateSwitchUI(device, status) {
      const switchElement = document.getElementById(`${device}-switch`);
      const iconElement = document.getElementById(`${device}-icon`);
      const statusElement = document.getElementById(`${device}-status`);

      // 장치 상태에 맞게 UI 업데이트
      if (status) {
        switchElement.checked = true;
        iconElement.classList.add('active');
        statusElement.textContent = '켜짐';

        // 팬이 켜지면 회전 애니메이션 추가
        if (device === 'fan') {
          iconElement.querySelector('i').classList.add('spin');
        }
      } else {
        switchElement.checked = false;
        iconElement.classList.remove('active');
        statusElement.textContent = '꺼짐';

        // 팬이 꺼지면 회전 애니메이션 제거
        if (device === 'fan') {
          iconElement.querySelector('i').classList.remove('spin');
        }
      }
    }  
  </script>
</body>
</html>