<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸íŒœ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #3b82f6;
      --secondary-color: #f3f4f6;
      --text-color: #1f2937;
      --muted-color: #6b7280;
      --border-color: #e5e7eb;
      --card-bg: #ffffff;
      --bg-color: #f9fafb;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      
      /* ì„¼ì„œ ìƒ‰ìƒ */
      --temp-color: #f97316;
      --humidity-color: #3b82f6;
      --soil-color: #FFDF00;
      --co2-color: #10b981;
      
      /* ì¥ì¹˜ ìƒ‰ìƒ */
      --led-color: #facc15;
      --fan-color: #3b82f6;
      --water-color: #06b6d4;
      --heater-color: #ef4444;
      --cooler-color: #6366f1;
      
      --border-radius: 0.5rem;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .header-right {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      align-items: center;
    }

    .logout-btn {
      position: flex;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      text-decoration: underline;
    }
    

    .date-picker {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background-color: var(--card-bg);
      cursor: pointer;
    }

    main {
      flex: 1;
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      border-bottom: 2px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 500;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .grid {
      display: grid;
      gap: 1.5rem;
    }

    .grid-cols-1 {
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .grid-cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .grid-cols-5 {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-description {
      color: var(--muted-color);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .card-content {
      padding: 1.5rem;
    }

    .card-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
    }

    .sensor-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .sensor-unit {
      font-size: 1rem;
      font-weight: normal;
      color: var(--muted-color);
      margin-left: 0.25rem;
    }

    .progress-container {
      width: 100%;
      height: 0.5rem;
      background-color: var(--secondary-color);
      border-radius: 9999px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      border-radius: 9999px;
    }

    .progress-bar.temp {
      background-color: var(--temp-color);
    }

    .progress-bar.humidity {
      background-color: var(--humidity-color);
    }

    .progress-bar.soil {
      background-color: var(--soil-color);
    }

    .progress-bar.co2 {
      background-color: var(--co2-color);
    }

    .device-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .device-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .device-icon {
      width: 4rem;
      height: 4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      background-color: var(--secondary-color);
      font-size: 1.5rem;
      color: var(--muted-color);
    }

    .device-icon.active.led {
      background-color: rgba(250, 204, 21, 0.2);
      color: var(--led-color);
    }

    .device-icon.active.fan {
      background-color: rgba(59, 130, 246, 0.2);
      color: var(--fan-color);
    }

    .device-icon.active.water {
      background-color: rgba(6, 182, 212, 0.2);
      color: var(--water-color);
    }

    .device-icon.active.heater {
      background-color: rgba(239, 68, 68, 0.2);
      color: var(--heater-color);
    }

    .device-icon.active.cooler {
      background-color: rgba(99, 102, 241, 0.2);
      color: var(--cooler-color);
    }

    .device-name {
      font-weight: 500;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 3rem;
      height: 1.5rem;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--secondary-color);
      transition: .4s;
      border-radius: 9999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 1rem;
      width: 1rem;
      left: 0.25rem;
      bottom: 0.25rem;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary-color);
    }

    input:checked + .slider:before {
      transform: translateX(1.5rem);
    }

    .switch-label {
      margin-left: 0.5rem;
    }

    .chart-container {
      width: 100%;
      height: 300px;
      position: relative;
    }

    .sensor-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .sensor-tab {
      padding: 0.75rem;
      text-align: center;
      border-radius: var(--border-radius);
      cursor: pointer;
      background-color: var(--secondary-color);
    }

    .sensor-tab.active.temp {
      background-color: rgba(249, 115, 22, 0.2);
      color: var(--temp-color);
    }

    .sensor-tab.active.humidity {
      background-color: rgba(59, 130, 246, 0.2);
      color: var(--humidity-color);
    }

    .sensor-tab.active.soil {
      background-color: rgba(217, 119, 6, 0.2);
      color: var(--soil-color);
    }

    .sensor-tab.active.co2 {
      background-color: rgba(16, 185, 129, 0.2);
      color: var(--co2-color);
    }

    .sensor-chart {
      display: none;
      height: 400px;
    }

    .sensor-chart.active {
      display: block;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background-color: var(--secondary-color);
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .spin {
      animation: spin 2s linear infinite;
    }

    .switch-container {
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <h1 class="header-title">ìŠ¤ë§ˆíŠ¸íŒœ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="header-right">
        <span id="farmname" style="color: #1a7e56; font-size: 20px; font-weight: bold;">New ìŠ¤ë§ˆíŠ¸íŒœ</span>
        <span id="username">í™ê¸¸ë™ë‹˜</span>
        <button class="logout-btn" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
        <!--<div class="date-picker" id="datePicker">
          <i class="fas fa-calendar"></i>
          <span id="currentDate"></span>
        </div>-->
      </div>
    </div>
  </header>

  <main>
    <div class="tabs">
      <div class="tab active" data-tab="current">í˜„ì¬ ìƒíƒœ</div>
      <div class="tab" data-tab="history">ê¸°ë¡ ë°ì´í„°</div>
      <div class="tab" data-tab="writeDiary">ì¼ì§€ ì‘ì„±</div>
    </div>

    <!-- í˜„ì¬ ìƒíƒœ íƒ­ -->
    <div class="tab-content active" id="current-tab">
      <!-- ì„¼ì„œ ë°ì´í„° ì¹´ë“œ -->
      <div class="grid grid-cols-1 grid-cols-2 grid-cols-4">
        <!-- ì˜¨ë„ ì¹´ë“œ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-temperature-high" style="color: var(--temp-color);"></i>
              ì˜¨ë„
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value temp">
              0<span class="sensor-unit">Â°C</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar temp" style="width: 63%;"></div>
            </div>
          </div>
        </div>

        <!-- ìŠµë„ ì¹´ë“œ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-tint" style="color: var(--humidity-color);"></i>
              ìŠµë„
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value humidity">
              0<span class="sensor-unit">%</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar humidity" style="width: 62%;"></div>
            </div>
          </div>
        </div>

        <!-- í† ì–‘ ìˆ˜ë¶„ ì¹´ë“œ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-leaf" style="color: var(--soil-color);"></i>
              í† ì–‘ ìˆ˜ë¶„
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value soil">
              0<span class="sensor-unit">%</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar soil" style="width: 55%;"></div>
            </div>
          </div>
        </div>

        <!-- CO2 ì¹´ë“œ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-wind" style="color: var(--co2-color);"></i>
              CO2
            </div>
          </div>
          <div class="card-content">
            <div class="sensor-value co2">
              0<span class="sensor-unit">ppm</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar co2" style="width: 42%;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì¥ì¹˜ ì œì–´ ì¹´ë“œ -->
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">ì¥ì¹˜ ì œì–´</div>
          <div class="card-description">ìŠ¤ë§ˆíŠ¸íŒœ ì¥ì¹˜ë¥¼ ì›ê²©ìœ¼ë¡œ ì œì–´í•©ë‹ˆë‹¤</div>
        </div>
        <div class="card-content">
          <div class="device-grid">
            <!-- LED ì œì–´ -->
            <div class="device-item">
              <div class="device-icon led" id="led-icon">
                <i class="fas fa-lightbulb"></i>
              </div>
              <div class="device-name">LED</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="led-switch" onchange="updateDevice('led')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="led-status">êº¼ì§</span>
              </div>
            </div>

            <!-- í™˜í’íŒ¬ ì œì–´ -->
            <div class="device-item">
              <div class="device-icon fan" id="fan-icon">
                <i class="fas fa-fan"></i>
              </div>
              <div class="device-name">í™˜í’íŒ¬</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="fan-switch" onchange="updateDevice('fan')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="fan-status">êº¼ì§</span>
              </div>
            </div>

            <!-- ë¬¼ì£¼ê¸° ì œì–´ -->
            <div class="device-item">
              <div class="device-icon water" id="water-icon">
                <i class="fas fa-tint"></i>
              </div>
              <div class="device-name">ë¬¼ì£¼ê¸°</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="water-switch" onchange="updateDevice('water')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="water-status">êº¼ì§</span>
              </div>
            </div>

            <!-- íˆí„° ì œì–´ -->
            <div class="device-item">
              <div class="device-icon heater" id="heater-icon">
                <i class="fas fa-fire"></i>
              </div>
              <div class="device-name">íˆí„°</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="heater-switch" onchange="updateDevice('heater')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="heater-status">êº¼ì§</span>
              </div>
            </div>

            <!-- ì¿¨ëŸ¬ ì œì–´ -->
            <div class="device-item">
              <div class="device-icon cooler" id="cooler-icon">
                <i class="fas fa-wind"></i>
              </div>
              <div class="device-name">ì¿¨ëŸ¬</div>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="cooler-switch" onchange="updateDevice('cooler')">
                  <span class="slider"></span>
                </label>
                <span class="switch-label" id="cooler-status">êº¼ì§</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì‹¤ì‹œê°„ ì„¼ì„œ ë°ì´í„° ê·¸ë˜í”„ -->
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">ì‹¤ì‹œê°„ ì„¼ì„œ ë°ì´í„°</div>
          <div class="card-description">ìµœê·¼ 24ì‹œê°„ ë°ì´í„° ì¶”ì´</div>
        </div>
        <div class="card-content">
          <div class="chart-container">
            <canvas id="realtime-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ê¸°ë¡ ë°ì´í„° íƒ­ -->
    <div class="tab-content" id="history-tab">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ì„¼ì„œ ë°ì´í„° ê¸°ë¡</div>
          <div class="card-description" id="history-date"></div>
        </div>
        <div class="card-content">
          <div class="sensor-tabs">
            <div class="sensor-tab active temp" data-sensor="temperature">ì˜¨ë„</div>
            <div class="sensor-tab humidity" data-sensor="humidity">ìŠµë„</div>
            <div class="sensor-tab soil" data-sensor="soil">í† ì–‘ ìˆ˜ë¶„</div>
            <div class="sensor-tab co2" data-sensor="co2">CO2</div>
          </div>

          <div class="sensor-chart active" id="temperature-chart">
            <canvas id="temperature-canvas"></canvas>
          </div>
          <div class="sensor-chart" id="humidity-chart">
            <canvas id="humidity-canvas"></canvas>
          </div>
          <div class="sensor-chart" id="soil-chart">
            <canvas id="soil-canvas"></canvas>
          </div>
          <div class="sensor-chart" id="co2-chart">
            <canvas id="co2-canvas"></canvas>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn" id="prev-date">
            <i class="fas fa-chevron-left"></i>
            ì´ì „ ë‚ ì§œ
          </button>
          <button class="btn" id="next-date">
            ë‹¤ìŒ ë‚ ì§œ
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- ì¼ì¼ ì„¼ì„œ ë°ì´í„° ìš”ì•½ -->
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-title">ì¼ì¼ ì„¼ì„œ ë°ì´í„° ìš”ì•½</div>
          <div class="card-description" id="summary-date"></div>
        </div>
        <div class="card-content">
          <div class="chart-container">
            <canvas id="summary-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ìŠ¤ë§ˆíŠ¸íŒœ ì¼ì§€ ì‘ì„± íƒ­ -->
    <div class="tab-content" id="writeDiary-tab">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ìŠ¤ë§ˆíŠ¸íŒœ ìš´ì˜ ì¼ì§€</div>
        </div>
        <div class="card-content">
          <!-- ìë™ ì¼ì§€ ì‘ì„± ë²„íŠ¼ -->
          <button id="generate-diary" class="btn">ì¼ì§€ ìë™ ì‘ì„±</button>
          
          <!-- ì¼ì§€ ëª©ë¡ -->
          <div id="diary-list" class="diary-list">
            <h3>ì‘ì„±ëœ ì¼ì§€</h3>
            <ul id="diary-entries"></ul>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    const API_BASE_URL = "https://port-0-server-m7tucm4sab201860.sel4.cloudtype.app";

    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ 
    const logoutButton = document.getElementById("logout-btn");       
    logoutButton.addEventListener("click", () => {
      sessionStorage.removeItem("user_id");
      alert("ë¡œê·¸ì•„ì›ƒ");
      window.location.href = "login.html";
    });

    document.addEventListener('DOMContentLoaded', async () => {
      // í˜„ì¬ ë‚ ì§œ ì„¤ì •
      const today = new Date();
      let currentDate = new Date();

      // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const weekdays = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
        const weekday = weekdays[date.getDay()];

        // ë‚ ì§œ í¬ë§·: "2025ë…„ 02ì›” 27ì¼ (ê¸ˆìš”ì¼)"
        return `${year}ë…„ ${month}ì›” ${day}ì¼ (${weekday})`;
      }

      // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
      function updateDateDisplay() {
        // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
        const formattedDate = formatDate(currentDate);
        
        // 'currentDate'ì™€ 'history-date'ì— ë‚ ì§œë§Œ í‘œì‹œ
        //document.getElementById('currentDate').textContent = formattedDate.split(' (')[0];
        document.getElementById('history-date').textContent = formattedDate;
        document.getElementById('summary-date').textContent = `${currentDate.getFullYear()}ë…„ ${currentDate.getMonth() + 1}ì›” ${currentDate.getDate()}ì¼ ì„¼ì„œë³„ í‰ê· ê°’`;
      }

      // íƒ­ ì „í™˜ ê¸°ëŠ¥
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          // íƒ­ í™œì„±í™”
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // íƒ­ ì»¨í…ì¸  í™œì„±í™”
          tabContents.forEach(content => content.classList.remove('active'));
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });
      
      // ì„¼ì„œ íƒ­ ì „í™˜ ê¸°ëŠ¥
      const sensorTabs = document.querySelectorAll('.sensor-tab');
      const sensorCharts = document.querySelectorAll('.sensor-chart');
      
      sensorTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const sensorId = tab.getAttribute('data-sensor');
          
          // ì„¼ì„œ íƒ­ í™œì„±í™”
          sensorTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // ì„¼ì„œ ì°¨íŠ¸ í™œì„±í™”
          sensorCharts.forEach(chart => chart.classList.remove('active'));
          document.getElementById(`${sensorId}-chart`).classList.add('active');
        });
      });
      
      document.getElementById('prev-date').addEventListener('click', async () => {
        currentDate.setDate(currentDate.getDate() - 1);
        updateDateDisplay();
        await updateAllCharts(); // ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      });
      
      document.getElementById('next-date').addEventListener('click', async () => {
        if (currentDate < today) {
          currentDate.setDate(currentDate.getDate() + 1);
          updateDateDisplay();
          await updateAllCharts(); // ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        }
      });

      // ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì—ì„œ user_idì™€ farm_id ê°€ì ¸ì˜¤ê¸°
      const userId = sessionStorage.getItem('user_id');
      const farmId = sessionStorage.getItem('farm_id');

      // ë†ì¥ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
      async function fetchFarmName() {
        try {
          const response = await fetch(`${API_BASE_URL}/getFarmName?user_id=${userId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();

          if (response.ok) {
            const farmname = data.farmname;
            document.getElementById('farmname').textContent = `${farmname}`;
          } else {
            console.error('ìŠ¤ë§ˆíŠ¸íŒœ ì´ë¦„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', data.message);
          }
        } catch (error) {
          console.error("ìŠ¤ë§ˆíŠ¸íŒœ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
      }

      // ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
      async function fetchName() {
        try {
          const response = await fetch(`${API_BASE_URL}/getName?user_id=${userId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();

          if (!response.ok) {
            throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
          }

          const username = data.username;
          document.getElementById('username').textContent = `${username}ë‹˜`;
        } catch (error) {
          console.error("ì‚¬ìš©ì ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
      }

      // ì„¼ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í™”ë©´ì— ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
      async function fetchSensorData() {
        try {
          if (!userId) {
            alert("ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            window.location.href = "login.html";
            return;
          }

          if (!farmId) {
            alert("ìŠ¤ë§ˆíŠ¸íŒœ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤ë§ˆíŠ¸íŒœ ì¶”ê°€ê°€ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            window.location.href = "farm.html";
            return;
          }

          const response = await fetch(`${API_BASE_URL}/sensors/status?user_id=${userId}&farm_id=${farmId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();

          if (!response.ok) {
            throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
          }

          // ê° ì„¼ì„œ ë°ì´í„° ì—…ë°ì´íŠ¸
          updateSensorUI('temperature', data.temperature, 'temp', 0, 40); // ì˜¨ë„
          updateSensorUI('humidity', data.humidity, 'humidity', 0, 100); // ìŠµë„
          updateSensorUI('soil_moisture', data.soil_moisture, 'soil', 0, 100); // í† ì–‘ ìˆ˜ë¶„
          updateSensorUI('co2', data.co2, 'co2', 0, 1000); // CO2
        } catch (error) {
          console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        }
      }

      // ì„¼ì„œ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateSensorUI(sensorType, value, className, min, max) {
        // ì„¼ì„œ ê°’ê³¼ ë‹¨ìœ„ ì„¤ì •
        let unit = '';
        switch (sensorType) {
          case 'temperature':
            unit = 'Â°C';
            break;
          case 'humidity':
          case 'soil_moisture':
            unit = '%';
            break;
          case 'co2':
            unit = 'ppm';
            break;
        }

        // ì„¼ì„œ ê°’ ì—…ë°ì´íŠ¸
        const valueElement = document.querySelector(`.sensor-value.${className}`);
        if (valueElement) {
          valueElement.innerHTML = `${value}<span class="sensor-unit">${unit}</span>`;
        }

        // ì§„í–‰ ë°” ë„ˆë¹„ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        const progressBar = document.querySelector(`.progress-container .progress-bar.${className}`);
        if (progressBar) {
          const percentage = ((value - min) / (max - min)) * 100;
          progressBar.style.width = `${Math.min(Math.max(percentage, 0), 100)}%`;
        }
      }

      // ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
      async function fetchDevicesStatus() {
        try {
          const response = await fetch(`${API_BASE_URL}/devices/status?user_id=${userId}&farm_id=${farmId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();

          if (!response.ok) {
            throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
          }

          // ê° ì¥ì¹˜ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateSwitchUI('led', data.led);
          updateSwitchUI('fan', data.fan);
          updateSwitchUI('water', data.water);
          updateSwitchUI('heater', data.heater);
          updateSwitchUI('cooler', data.cooler);
        } catch (error) {
          console.error('ìƒíƒœ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        }
      }

      // ì‹¤ì‹œê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      async function fetchRealtimeData() {
        try {
          const response = await fetch(`${API_BASE_URL}/realtime-data?user_id=${userId}&farm_id=${farmId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();

          if (!response.ok) {
            throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
          }

          // ì„œë²„ ì‘ë‹µ ë°ì´í„° í˜•ì‹ì— ë”°ë¼ ê°€ê³µ
          const processedData = data.map(item => ({
            time: new Date(item.time_interval).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false }),
            temperature: parseFloat(item.avg_temperature),
            humidity: parseFloat(item.avg_humidity),
            soil: parseFloat(item.avg_soil_moisture),
            co2: parseInt(item.avg_co2)
          }));

          return processedData;
        } catch (error) {
          console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
          return [];
        }
      }

      // ì‹¤ì‹œê°„ ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
      async function updateChartData() {
        const realtimeData = await fetchRealtimeData();
        
        // ì°¨íŠ¸ ë°ì´í„° ê°±ì‹ 
        realtimeChart.data.labels = realtimeData.map(item => item.time);
        realtimeChart.data.datasets[0].data = realtimeData.map(item => item.temperature);
        realtimeChart.data.datasets[1].data = realtimeData.map(item => item.humidity);
        realtimeChart.data.datasets[2].data = realtimeData.map(item => item.soil);
        realtimeChart.data.datasets[3].data = realtimeData.map(item => item.co2);
        
        realtimeChart.update();
      }

      // ì°¨íŠ¸ ì´ˆê¸°í™”
      const realtimeChart = new Chart(
        document.getElementById('realtime-chart'),
        {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'ì˜¨ë„ (Â°C)',
                data: [],
                borderColor: 'rgb(249, 115, 22)',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y1', 
              },
              {
                label: 'ìŠµë„ (%)',
                data: [],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y1',  
              },
              {
                label: 'í† ì–‘ ìˆ˜ë¶„ (%)',
                data: [],
                borderColor: 'rgb(255, 223, 0)',
                backgroundColor: 'rgba(255, 223, 0, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y1', 
              },
              {
                label: 'CO2 (ppm)',
                data: [],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                yAxisID: 'y2',  
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              // ì¢Œì¸¡ yì¶• (ì˜¨ë„, ìŠµë„, í† ì–‘ ìˆ˜ë¶„)
              y1: {
                beginAtZero: false,
                position: 'left',
                ticks: {
                  max: 80, 
                  min: 0, 
                }
              },
              // ìš°ì¸¡ yì¶• (CO2)
              y2: {
                beginAtZero: false,
                position: 'right',
                grid: {
                  drawOnChartArea: false, 
                },
                ticks: {
                  max: 1000, 
                  min: 0,  
                }
              }
            }
          }
        }
      );
      
      // ê¸°ë¡ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      async function fetchHistoryData() {
        // "2025ë…„ 02ì›” 27ì¼ (ëª©ìš”ì¼)"ì—ì„œ "2025ë…„ 02ì›” 27ì¼"ë§Œ ì¶”ì¶œ
        const selectedDate = document.getElementById('history-date').innerText.split(' (')[0];
      
        // ë‚ ì§œ ë³€í™˜: "2025ë…„ 02ì›” 27ì¼" -> "2025-02-27"
        let formattedDate = selectedDate.replace('ë…„', '-').replace('ì›”', '-').replace('ì¼', '').replace(/\s+/g, '').trim();
      
        // '2025-02-27' í˜•ì‹ì¸ì§€ í™•ì¸í•˜ê³ , ì•„ë‹ˆë©´ ì˜¤ë¥˜ ì²˜ë¦¬
        const datePattern = /^\d{4}-\d{2}-\d{2}$/;

        if (!datePattern.test(formattedDate)) {
          console.error('ë‚ ì§œ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤:', formattedDate);
          return { timeLabels: [], temperatureData: [], humidityData: [], soilData: [], co2Data: [] };
        }
      
        try {
          const response = await fetch(`${API_BASE_URL}/history-data?user_id=${userId}&farm_id=${farmId}&date=${formattedDate}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });
      
          const data = await response.json();
      
          if (!response.ok) {
            throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
          }
          
          // ì„œë²„ ì‘ë‹µì´ ë°°ì—´ì¸ì§€ í™•ì¸
          if (!Array.isArray(data)) {
            console.error('ì„œë²„ ì‘ë‹µ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.', data);
            return { timeLabels: [], temperatureData: [], humidityData: [], soilData: [], co2Data: [] };
          }
      
          // ì„œë²„ ì‘ë‹µ ë°ì´í„° ê°€ê³µ
          const processedData = {
            timeLabels: data.map(item => new Date(item.time_interval).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false })),
            temperatureData: data.map(item => parseFloat(item.avg_temperature)),
            humidityData: data.map(item => parseFloat(item.avg_humidity)),
            soilData: data.map(item => parseFloat(item.avg_soil_moisture)),
            co2Data: data.map(item => parseInt(item.avg_co2)),
          };
      
          return processedData;
        } catch (error) {
          console.error('ê¸°ë¡ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
          return { timeLabels: [], temperatureData: [], humidityData: [], soilData: [], co2Data: [] };
        }
      }

      // ë³€ìˆ˜ ì„ ì–¸ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
      let timeLabels = [];
      let temperatureData = [];
      let humidityData = [];
      let soilData = [];
      let co2Data = [];

      // ê¸°ë¡ ì°¨íŠ¸ ë°ì´í„° ê°±ì‹ 
      async function updateHistoryChartData() {
        const historyData = await fetchHistoryData();
      
        // ì˜¨ë„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        temperatureChart.data.labels = historyData.timeLabels;
        temperatureChart.data.datasets[0].data = historyData.temperatureData;
        temperatureChart.update();
      
        // ìŠµë„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        humidityChart.data.labels = historyData.timeLabels;
        humidityChart.data.datasets[0].data = historyData.humidityData;
        humidityChart.update();
      
        // í† ì–‘ ìˆ˜ë¶„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        soilChart.data.labels = historyData.timeLabels;
        soilChart.data.datasets[0].data = historyData.soilData;
        soilChart.update();
      
        // CO2 ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        co2Chart.data.labels = historyData.timeLabels;
        co2Chart.data.datasets[0].data = historyData.co2Data;
        co2Chart.update();
      }    

      // ì˜¨ë„ ì°¨íŠ¸
      const temperatureChart = new Chart(
        document.getElementById('temperature-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: 'ì˜¨ë„ (Â°C)',
                data: temperatureData,
                borderColor: 'rgb(249, 115, 22)',
                backgroundColor: 'rgba(249, 115, 22, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 40,
                title: {
                  display: true,
                  text: 'ì˜¨ë„ (Â°C)'
                }
              }
            }
          }
        }
      );
      
      // ìŠµë„ ì°¨íŠ¸
      const humidityChart = new Chart(
        document.getElementById('humidity-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: 'ìŠµë„ (%)',
                data: humidityData,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 100,
                title: {
                  display: true,
                  text: 'ìŠµë„ (%)'
                }
              }
            }
          }
        }
      );
      
      // í† ì–‘ ìˆ˜ë¶„ ì°¨íŠ¸
      const soilChart = new Chart(
        document.getElementById('soil-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: 'í† ì–‘ ìˆ˜ë¶„ (%)',
                data: soilData,
                borderColor: 'rgb(217, 119, 6)',
                backgroundColor: 'rgba(217, 119, 6, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 100,
                title: {
                  display: true,
                  text: 'í† ì–‘ ìˆ˜ë¶„ (%)'
                }
              }
            }
          }
        }
      );
      
      // CO2 ì°¨íŠ¸
      const co2Chart = new Chart(
        document.getElementById('co2-canvas'),
        {
          type: 'line',
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: 'CO2 (ppm)',
                data: co2Data,
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                min: 0,
                max: 1000,
                title: {
                  display: true,
                  text: 'CO2 (ppm)'
                }
              }
            }
          }
        }
      );

      // í‰ê·  ë°ì´í„°
      async function updateSummaryChart() {
        const historyData = await fetchHistoryData();
        
        // ê° í•­ëª©ì˜ í‰ê· ê°’ ê³„ì‚°
        const avgTemperature = roundToTwo(average(historyData.temperatureData));
        const avgHumidity = roundToTwo(average(historyData.humidityData));
        const avgSoil = roundToTwo(average(historyData.soilData));
        const avgCo2 = roundToTwo(average(historyData.co2Data)); // CO2ëŠ” 10ìœ¼ë¡œ ë‚˜ëˆ„ì§€ ì•ŠìŒ, í›„ì— ì°¨íŠ¸ì—ì„œ ë‚˜ëˆ„ê¸°
        
        // ìš”ì•½ ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
        summaryChart.data.datasets[0].data = [avgTemperature]; // ì˜¨ë„ í‰ê· ê°’
        summaryChart.data.datasets[1].data = [avgHumidity];   // ìŠµë„ í‰ê· ê°’
        summaryChart.data.datasets[2].data = [avgSoil];       // í† ì–‘ ìˆ˜ë¶„ í‰ê· ê°’
        summaryChart.data.datasets[3].data = [avgCo2 / 10];   // CO2 í‰ê· ê°’ (ì°¨íŠ¸ì—ì„œë§Œ ë‚˜ëˆ„ê¸°)
        
        summaryChart.update();
      }
      
      // í‰ê· ê°’ ê³„ì‚° í•¨ìˆ˜
      function average(dataArray) {
        if (dataArray.length === 0) return 0;
        const sum = dataArray.reduce((acc, value) => acc + value, 0);
        return sum / dataArray.length;
      }
      
      // ì†Œìˆ˜ì  2ìë¦¬ ë°˜ì˜¬ë¦¼ í•¨ìˆ˜
      function roundToTwo(num) {
        return Math.round(num * 100) / 100;
      }

      // ìš”ì•½ ì°¨íŠ¸
      const summaryChart = new Chart(
        document.getElementById('summary-chart'),
        {
          type: 'bar',
          data: {
            labels: ['í‰ê· ê°’'],
            datasets: [
              {
                label: 'ì˜¨ë„ (Â°C)',
                data: [24.5],
                backgroundColor: 'rgba(249, 115, 22, 0.7)',
                borderColor: 'rgb(249, 115, 22)',
                borderWidth: 1
              },
              {
                label: 'ìŠµë„ (%)',
                data: [65],
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
              },
              {
                label: 'í† ì–‘ ìˆ˜ë¶„ (%)',
                data: [42],
                backgroundColor: 'rgba(217, 119, 6, 0.7)',
                borderColor: 'rgb(217, 119, 6)',
                borderWidth: 1
              },
              {
                label: 'CO2 (ppm/10)',
                data: [65],
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: 'rgb(16, 185, 129)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.dataset.label === 'CO2 (ppm/10)') {
                      label += context.raw * 10; // íˆ´íŒì—ì„œ ì›ë³¸ CO2 ê°’ìœ¼ë¡œ ë³µì›
                    } else {
                      label += context.raw;
                    }
                    return label;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        }
      );   

      // ê¸°ë¡, ìš”ì•½ì•½ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateAllCharts() {
        const historyData = await fetchHistoryData();

        // historyDataê°€ í•„ìš”í•œ ë°ì´í„°ë¥¼ ëª¨ë‘ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
        if (!historyData.timeLabels || !historyData.temperatureData || !historyData.humidityData || !historyData.soilData || !historyData.co2Data) {
          console.error('History dataê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');
          return;
        }

        // ìƒˆë¡œìš´ ë°ì´í„° í• ë‹¹
        const newTimeLabels = historyData.timeLabels;
        const newTemperatureData = historyData.temperatureData;
        const newHumidityData = historyData.humidityData;
        const newSoilData = historyData.soilData;
        const newCo2Data = historyData.co2Data;

        // realtimeChart ì—…ë°ì´íŠ¸
        //realtimeChart.data.labels = newTimeLabels;
        //realtimeChart.data.datasets[0].data = newTemperatureData;
        //realtimeChart.data.datasets[1].data = newHumidityData;
        //realtimeChart.data.datasets[2].data = newSoilData;
        //realtimeChart.data.datasets[3].data = newCo2Data;
        //realtimeChart.update();

        // temperatureChart ì—…ë°ì´íŠ¸
        temperatureChart.data.labels = newTimeLabels;
        temperatureChart.data.datasets[0].data = newTemperatureData;
        temperatureChart.update();

        // humidityChart ì—…ë°ì´íŠ¸
        humidityChart.data.labels = newTimeLabels;
        humidityChart.data.datasets[0].data = newHumidityData;
        humidityChart.update();

        // soilChart ì—…ë°ì´íŠ¸
        soilChart.data.labels = newTimeLabels;
        soilChart.data.datasets[0].data = newSoilData;
        soilChart.update();

        // co2Chart ì—…ë°ì´íŠ¸
        co2Chart.data.labels = newTimeLabels;
        co2Chart.data.datasets[0].data = newCo2Data;
        co2Chart.update();

        // summaryChart í‰ê· ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        const tempAvg = newTemperatureData.reduce((a, b) => a + b, 0) / newTemperatureData.length;
        const humidityAvg = newHumidityData.reduce((a, b) => a + b, 0) / newHumidityData.length;
        const soilAvg = newSoilData.reduce((a, b) => a + b, 0) / newSoilData.length;
        const co2Avg = newCo2Data.reduce((a, b) => a + b, 0) / newCo2Data.length / 10;

        summaryChart.data.datasets[0].data = [tempAvg.toFixed(1)];
        summaryChart.data.datasets[1].data = [humidityAvg.toFixed(1)];
        summaryChart.data.datasets[2].data = [soilAvg.toFixed(1)];
        summaryChart.data.datasets[3].data = [co2Avg.toFixed(1)];
        summaryChart.update();
      }

      // ì¼ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadDiaryEntries() {
        const userId = sessionStorage.getItem("user_id");
        const farmId = sessionStorage.getItem("farm_id");

        try {
          const response = await axios.get(`${API_BASE_URL}/get-diary-entries`, {
            params: { user_id: userId, farm_id: farmId },
          });

          console.log("ğŸ“– ì¼ì§€ ëª©ë¡:", response.data);
        } catch (error) {
          console.error("âŒ ì¼ì§€ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:", error);
        }
      }

      fetchFarmName() // ìŠ¤ë§ˆíŠ¸íŒœ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      fetchName(); // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      updateDateDisplay(); // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
      fetchSensorData(); // ì„¼ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetchDevicesStatus(); // ì¥ì¹˜ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
      updateChartData(); // ì‹¤ì‹œê°„ ì°¨íŠ¸ ê°€ì ¸ì˜¤ê¸°
      updateHistoryChartData(); // ê¸°ë¡ ì°¨íŠ¸ ê°€ì ¸ì˜¤ê¸°
      updateSummaryChart(); // ìš”ì•½ ì°¨íŠ¸ ê°€ì ¸ì˜¤ê¸°

      //setInterval(fetchSensorData, 5000);
      //setInterval(updateChartData, 300000);
    });

    // ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì—ì„œ user_idì™€ farm_id ê°€ì ¸ì˜¤ê¸°
    const userId = sessionStorage.getItem('user_id');
    const farmId = sessionStorage.getItem('farm_id');

    // ìƒíƒœ ë³€ê²½í•˜ê¸°
    async function updateDevice(device) {
      try {
        // user_idì™€ farm_idê°€ ì¡´ì¬í•  ê²½ìš°ì—ë§Œ ìš”ì²­
        if (userId && farmId) {
          // í˜„ì¬ í† ê¸€ ìƒíƒœ í™•ì¸
          const isChecked = document.getElementById(`${device}-switch`).checked;

          // ì„œë²„ë¡œ ìƒíƒœ ë³€ê²½ ìš”ì²­
          await fetch(`${API_BASE_URL}/devices/${device}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              user_id: userId, 
              farm_id: farmId, 
              device: device, 
              status: isChecked 
            })
          });

          // ìƒíƒœ ì—…ë°ì´íŠ¸
          updateSwitchUI(device, isChecked);

        } else {
            console.error('user_id ë˜ëŠ” farm_idê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
          console.error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
      }
    }

    // ìŠ¤ìœ„ì¹˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateSwitchUI(device, status) {
      const switchElement = document.getElementById(`${device}-switch`);
      const iconElement = document.getElementById(`${device}-icon`);
      const statusElement = document.getElementById(`${device}-status`);

      // ì¥ì¹˜ ìƒíƒœì— ë§ê²Œ UI ì—…ë°ì´íŠ¸
      if (status) {
        switchElement.checked = true;
        iconElement.classList.add('active');
        statusElement.textContent = 'ì¼œì§';

        // íŒ¬ì´ ì¼œì§€ë©´ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        if (device === 'fan') {
          iconElement.querySelector('i').classList.add('spin');
        }
      } else {
        switchElement.checked = false;
        iconElement.classList.remove('active');
        statusElement.textContent = 'êº¼ì§';

        // íŒ¬ì´ êº¼ì§€ë©´ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
        if (device === 'fan') {
          iconElement.querySelector('i').classList.remove('spin');
        }
      }
    }  

    // Together AI API í‚¤ ê°€ì ¸ì˜¤ê¸°ê¸°
    async function getApiKey() {
      try {
        const response = await fetch(`${API_BASE_URL}/api-key`);
        const data = await response.json();
        return data.apiKey;
      } catch (error) {
        console.error("API í‚¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        return null;
      }
    }

    // ì„¼ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchSensorData(userId, farmId) {
      const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

      try {
        const response = await axios.get(`${API_BASE_URL}/get-sensor-data`, {
          params: { user_id: userId, farm_id: farmId, date: today },
        });
        console.log("âœ… ì„œë²„ ì‘ë‹µ:", response);
        return response.data;
      } catch (error) {
        console.error("âŒ ì„¼ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error.response?.data || error);
        return null;
      }
    }

    // AI ì¼ì§€ ì‘ì„± í•¨ìˆ˜
    async function getFarmLog(sensorData) {
      const prompt = `
          ğŸ“… ìŠ¤ë§ˆíŠ¸íŒœ ìš´ì˜ ê¸°ë¡ (${sensorData.date})
          - í‰ê·  ì˜¨ë„: ${sensorData.avg_temp}â„ƒ
          - í‰ê·  ìŠµë„: ${sensorData.avg_humidity}%
          - í† ì–‘ ìˆ˜ë¶„: ${sensorData.avg_soil_moisture}%
          - CO2 ë†ë„: ${sensorData.avg_co2}ppm
      `;

      try {
        const API_KEY = await getApiKey();
        if (!API_KEY) {
          alert("API í‚¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const response = await axios.post(
          "https://api.together.xyz/v1/chat/completions",
          {
            model: "mistral-7b-instruct",
            messages: [
              { role: "system", content: "ë„ˆëŠ” ìŠ¤ë§ˆíŠ¸íŒœ AI ë¹„ì„œë¡œì„œ ì¼ì§€ë¥¼ ì‘ì„±í•´ì•¼ í•œë‹¤." },
              { role: "user", content: prompt },
            ],
            temperature: 0.7,
          },
          {
            headers: {
              Authorization: `Bearer ${API_KEY}`,
              "Content-Type": "application/json",
            },
          }
        );

        return response.data.choices[0].message.content;
      } catch (error) {
        console.error("âŒ AI ì¼ì§€ ìƒì„± ì˜¤ë¥˜:", error.response?.data || error);
        return "âš ï¸ AI ì¼ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    // AI ì¼ì§€ ìë™ ì‘ì„± ë° ì €ì¥ í•¨ìˆ˜
    async function generateAndSaveDiary() {
      const sensorData = await fetchSensorData(userId, farmId);
      if (!sensorData) {
        alert("ì„¼ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const farmLog = await getFarmLog(sensorData);

      try {
        const response = await axios.post(`${API_BASE_URL}/save-diary`, {
          user_id: userId,
          farm_id: farmId,
          content: farmLog,
        });

        if (response.data.success) {
          alert("âœ… ì¼ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
          loadDiaryEntries();
        } else {
          alert("âŒ ì¼ì§€ ì €ì¥ ì‹¤íŒ¨!");
        }
      } catch (error) {
        console.error("âŒ ì¼ì§€ ì €ì¥ ì˜¤ë¥˜:", error);
        alert("âš ï¸ ì¼ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }
    document.getElementById("generate-diary").addEventListener("click", generateAndSaveDiary);
  </script>
</body>
</html>